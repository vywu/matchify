<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Spotifymatching</title>
  <base href="/">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <a href="/login">Login</a>
  <input type="text" id="id" value="Please enter the id">
  <input type="submit" value="Listen with" onclick="subscribeToUser()">


</head>
<script src=https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<body>
  <app-root></app-root>
</body>
<script>
  var socket;
  var clientid;
  function subscribeToUser(){
      var subid=$("#id").val();
      console.log(clientid);
      console.log(subid);
      socket.emit("subscribe",{subscriberid:clientid,subscribeeid:subid});

  }
  function getHashParams() {
    var hashParams = {};
    var e, r = /([^&;=]+)=?([^&;]*)/g,
      q = window.location.hash.substring(1);
    while ( e = r.exec(q)) {
      hashParams[e[1]] = decodeURIComponent(e[2]);
    }
    return hashParams;
  }
  var params=getHashParams();
  var access_token=params.access_token,
      refresh_token=params.refresh_token,
      error=params.error;

  if(error){
      alert("There was an error during authentication");
  }
  else{
      if(access_token){
          $.ajax({
          url: 'https://api.spotify.com/v1/me',
          headers: {
            'Authorization': 'Bearer ' + access_token
          },
          success: function(response) {
            socket=io.connect('http://localhost:3000',{reconnect:false});
            socket.emit('sendEmail',{email:response.email});
            socket.on('sendId',function(data){
              clientid=data.id;
              console.log(clientid);
            });
          }
        });



//        console.log(socket);
      }
  }

</script>
</html>
